# 広告管理システム - Xbiz対応 .htaccess設定
# PHP版 URL Rewriteとセキュリティ設定 (ads_reports)

# Apache Rewrite Engine
RewriteEngine On

# セキュリティヘッダー設定
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# 文字エンコーディング設定
AddDefaultCharset UTF-8

# ファイル型別設定
<IfModule mod_mime.c>
    AddType application/json .json
    AddType text/css .css
    AddType application/javascript .js
</IfModule>

# APIルーティング設定 (ads_reports用)
# /ads_reports/api/dashboard/data -> /ads_reports/api/dashboard/data.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/dashboard/data/?$ api/dashboard/data.php [QSA,L]

# /ads_reports/api/clients -> /ads_reports/api/clients/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/clients/?$ api/clients/index.php [QSA,L]

# /ads_reports/api/clients/123 -> /ads_reports/api/clients/index.php?id=123
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/clients/([0-9]+)/?$ api/clients/index.php?id=$1 [QSA,L]

# /ads_reports/api/ad-accounts -> /ads_reports/api/ad-accounts/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/ad-accounts/?$ api/ad-accounts/index.php [QSA,L]

# /ads_reports/api/invoices -> /ads_reports/api/invoices/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/invoices/?$ api/invoices/index.php [QSA,L]

# /ads_reports/api/cost-markups -> /ads_reports/api/cost-markups/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/cost-markups/?$ api/cost-markups/index.php [QSA,L]

# 管理画面ページルーティング (ads_reports用)
# /ads_reports/dashboard -> /ads_reports/index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^dashboard/?$ index.php [QSA,L]

# /ads_reports/clients -> /ads_reports/clients.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^clients/?$ clients.php [QSA,L]

# /ads_reports/ad-accounts -> /ads_reports/ad-accounts.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^ad-accounts/?$ ad-accounts.php [QSA,L]

# /ads_reports/invoices -> /ads_reports/invoices.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^invoices/?$ invoices.php [QSA,L]

# セキュリティ: 機密ファイルへのアクセス拒否
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

<Files ".env.*">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.json">
    Order allow,deny
    Deny from all
</Files>

<Files "composer.lock">
    Order allow,deny
    Deny from all
</Files>

<Files "*.log">
    Order allow,deny
    Deny from all
</Files>

<Files "bootstrap.php">
    Order allow,deny
    Deny from all
</Files>

# ディレクトリブラウジング無効化
Options -Indexes

# config/ディレクトリへの直接アクセス拒否
<Directory "config">
    Order allow,deny
    Deny from all
</Directory>

# app/ディレクトリへの直接アクセス拒否  
<Directory "app">
    Order allow,deny
    Deny from all
</Directory>

# database/ディレクトリへの直接アクセス拒否
<Directory "database">
    Order allow,deny
    Deny from all
</Directory>

# logs/ディレクトリへの直接アクセス拒否
<Directory "logs">
    Order allow,deny
    Deny from all
</Directory>

# vendor/ディレクトリへの直接アクセス拒否
<Directory "vendor">
    Order allow,deny
    Deny from all
</Directory>

# GZIP圧縮設定（パフォーマンス向上）
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# キャッシュ設定
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
</IfModule>

# エラーページ設定（本番環境用）
ErrorDocument 404 /ads_reports/404.php
ErrorDocument 500 /ads_reports/500.php

# PHP設定（必要に応じて）
<IfModule mod_php.c>
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log "logs/php_errors.log"
    php_value max_execution_time 60
    php_value memory_limit 256M
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
</IfModule>